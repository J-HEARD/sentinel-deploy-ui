id: baseline-azure-resource-inventory
name: Baseline - Azure Resource Inventory and Suspicious Configurations
description: |
  Baseline Content Pack - Hunting query to inventory Azure resources and identify potentially suspicious configurations.
  This query helps identify unauthorized resources or misconfigured security settings.
  
  Data Sources: AzureActivity
  Tactics: Defense Evasion, Persistence
  Techniques: T1078, T1098, T1562

query: |
  // Get resource creation activities
  let resourceCreation = AzureActivity
  | where TimeGenerated > ago(30d)
  | where OperationName contains "Create"
  | where ActivityStatus == "Success"
  | extend 
      ResourceName = tostring(parse_json(Properties).resourceName),
      ResourceType = tostring(parse_json(Properties).resourceType),
      ResourceGroup = tostring(parse_json(Properties).resourceGroup),
      Location = tostring(parse_json(Properties).location),
      SubscriptionId = tostring(parse_json(Properties).subscriptionId)
  | where isnotempty(ResourceName);

  // Get security-related modifications
  let securityModifications = AzureActivity
  | where TimeGenerated > ago(30d)
  | where OperationName in (
      "Microsoft.Network/networkSecurityGroups/securityRules/write",
      "Microsoft.KeyVault/vaults/accessPolicies/write",
      "Microsoft.Storage/storageAccounts/write",
      "Microsoft.Compute/virtualMachines/write"
  )
  | where ActivityStatus == "Success"
  | extend 
      ResourceName = tostring(parse_json(Properties).resourceName),
      ResourceType = tostring(parse_json(Properties).resourceType),
      ResourceGroup = tostring(parse_json(Properties).resourceGroup),
      ModificationType = OperationName
  | where isnotempty(ResourceName);

  // Combine and analyze
  resourceCreation
  | union securityModifications
  | summarize 
      ResourceCount = count(),
      ResourceTypes = make_set(ResourceType),
      Locations = make_set(Location),
      ResourceGroups = make_set(ResourceGroup),
      Operations = make_set(OperationName),
      LastActivity = max(TimeGenerated)
      by Caller, bin(TimeGenerated, 1d)
  | where ResourceCount > 5  // High resource activity
  | project 
      TimeGenerated,
      Caller,
      ResourceCount,
      ResourceTypes,
      Locations,
      ResourceGroups,
      Operations,
      LastActivity

tactics:
  - Defense_Evasion
  - Persistence
techniques:
  - T1078
  - T1098
  - T1562
tags:
  - baseline
  - hunting
  - azure-resources
  - resource-inventory
  - suspicious-configurations 