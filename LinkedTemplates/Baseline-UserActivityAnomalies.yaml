id: baseline-user-activity-anomalies
name: Baseline - User Activity Anomalies Hunting Query
description: |
  Baseline Content Pack - Hunting query to identify unusual user activity patterns across Office 365 and Azure AD.
  This query helps identify potential account compromise or insider threats.
  
  Data Sources: OfficeActivity, AuditLogs
  Tactics: Initial Access, Persistence, Data Exfiltration
  Techniques: T1078, T1098, T1567

query: |
  // Get user activity from Office 365
  let officeActivity = OfficeActivity
  | where TimeGenerated > ago(7d)
  | where Operation in ("MailItemsAccessed", "FileDownloaded", "FileAccessed", "TeamsSessionStarted")
  | extend 
      UserId = tostring(parse_json(Parameters).UserId),
      ClientIP = tostring(parse_json(Parameters).ClientIP),
      UserAgent = tostring(parse_json(Parameters).UserAgent)
  | where isnotempty(UserId)
  | summarize 
      OfficeActivityCount = count(),
      OfficeOperations = make_set(Operation),
      OfficeIPs = make_set(ClientIP),
      OfficeUserAgents = make_set(UserAgent),
      LastOfficeActivity = max(TimeGenerated)
      by UserId, bin(TimeGenerated, 1d);

  // Get authentication activity from Azure AD
  let authActivity = AuditLogs
  | where TimeGenerated > ago(7d)
  | where OperationName in ("UserLogin", "UserLoginFailed")
  | extend 
      UserPrincipalName = tostring(parse_json(TargetResources).userPrincipalName),
      IPAddress = tostring(parse_json(TargetResources).ipAddress),
      UserAgent = tostring(parse_json(TargetResources).userAgent)
  | where isnotempty(UserPrincipalName)
  | summarize 
      AuthCount = count(),
      AuthOperations = make_set(OperationName),
      AuthIPs = make_set(IPAddress),
      AuthUserAgents = make_set(UserAgent),
      LastAuthActivity = max(TimeGenerated)
      by UserPrincipalName, bin(TimeGenerated, 1d);

  // Join and analyze for anomalies
  officeActivity
  | join kind=inner authActivity on $left.UserId == $right.UserPrincipalName
  | where OfficeActivityCount > 100 or AuthCount > 50  // High activity thresholds
  | where array_length(OfficeIPs) > 5 or array_length(AuthIPs) > 3  // Multiple IP addresses
  | project 
      TimeGenerated,
      UserId,
      OfficeActivityCount,
      AuthCount,
      OfficeOperations,
      AuthOperations,
      OfficeIPs,
      AuthIPs,
      OfficeUserAgents,
      AuthUserAgents,
      LastOfficeActivity,
      LastAuthActivity

tactics:
  - Initial_Access
  - Persistence
  - Data_Exfiltration
techniques:
  - T1078
  - T1098
  - T1567
tags:
  - baseline
  - hunting
  - user-activity
  - anomalies
  - account-compromise 